# Redirect all incoming HTTP traffic to HTTPS
# This ensures that the application is always accessed over a secure connection
server {
    listen 80;
    server_name devblog-cms.edoandcode.cc www.devblog.edoandcode.cc;

    # Permanent redirect to the same host and URI over HTTPS
    return 301 https://$host$request_uri;
}

# HTTPS server block acting as a reverse proxy for the CMS backend
server {
    listen 443 ssl;

    # Domain name served by this virtual host
    server_name devblog-cms.edoandcode.cc;

    # TLS certificate and private key managed by Let's Encrypt
    ssl_certificate /etc/letsencrypt/live/edoandcode.cc/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/edoandcode.cc/privkey.pem;

    # Maximum allowed size for client request bodies (e.g. file uploads)
    client_max_body_size 50M; 

    # Main location block: forward all requests to the backend service
    location / {
        # Reverse proxy to the backend application (e.g. Strapi)
        proxy_pass http://backend:1337;

        # Enable WebSocket support by using HTTP/1.1
        # and forwarding the required upgrade headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';

        # Standard forwarded headers:
        # - Preserve original host
        # - Forward client IP information to the backend
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Inform the backend about the original protocol (HTTP or HTTPS)
        # Useful for generating correct absolute URLs
        proxy_set_header X-Forwarded-Proto $scheme;

        # Disable proxy caching when upgrading connections (e.g. WebSockets)
        # to avoid unexpected cached responses
        proxy_cache_bypass $http_upgrade;

        # Timeouts to handle long-running requests without premature termination
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
    }
}
